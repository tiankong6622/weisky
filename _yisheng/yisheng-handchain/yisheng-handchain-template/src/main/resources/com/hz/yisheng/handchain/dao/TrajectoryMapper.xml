<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.hz.yisheng.handchain.dao.TrajectoryMapper">
	<resultMap type="com.hz.yisheng.handchain.orm.Trajectory" id="TRAJECTORY_RESULT">
		<id property="id" column="id"/>
		<result property="customerId" column="customer_id"/>
		<result property="coordX" column="coord_x"/>
		<result property="coordY" column="coord_y"/>
		<result property="coordZ" column="coord_z"/>
		<result property="creator" column="creator"/>
		<result property="createTime" column="create_time"/>
		<result property="updater" column="updater"/>
		<result property="updateTime" column="update_time"/>
		<result property="isDeleted" column="is_deleted"/>
	</resultMap>	
	
	<sql id="TRAJECTORY_SQL">
		customer_id,coord_x,coord_y,coord_z,creator,create_time,updater,update_time,is_deleted
	</sql>
	
	<insert id="insert" parameterType="com.hz.yisheng.handchain.orm.Trajectory" useGeneratedKeys="true" keyProperty="id"  keyColumn="id">
		insert into child_trajectory(id,<include refid="TRAJECTORY_SQL"/>) values(id,#{customerId},#{coordX},#{coordY},#{coordZ},#{creator},now(),#{updater},#{updateTime},1)
	</insert>
	
	<update id="update" parameterType="com.hz.yisheng.handchain.orm.Trajectory">
		update child_trajectory set id=#{id}
		<if test="customerId != null and customerId != ''">
			<![CDATA[,customer_id =#{customerId}]]>
		</if>
		where id=#{id} and is_deleted=1
	</update>
	
	<select id="list" parameterType="java.util.HashMap" resultMap="TRAJECTORY_RESULT">
		select t.id,t.coord_x,t.coord_y,t.coord_z,t.create_time,c.`name` from child_trajectory t
		left join customer_base c on c.id = t.customer_id and c.is_deleted = 1
		where t.is_deleted = 1
		<if test="id != null and id != ''">
			<![CDATA[ and t.id =#{id}]]>
		</if>
		<if test="name != null and name != ''">
			<![CDATA[ and c.name LIKE CONCAT('%',#{name},'%')]]>
		</if>
		order by t.create_time desc,t.id DESC
		<if test="rowStart!=null and pageSize!=null">
			<![CDATA[limit #{rowStart},#{pageSize}]]>
		</if> 
	</select>
	
	<select id="count" resultType="java.lang.Long" parameterType="java.util.HashMap">
		select count(t.id) from child_trajectory t
		left join customer_base c on c.id = t.customer_id and c.is_deleted = 1
		where t.is_deleted = 1
		<if test="id != null and id != ''">
			<![CDATA[ and t.id =#{id}]]>
		</if>
		<if test="name != null and name != ''">
			<![CDATA[ and c.name LIKE CONCAT('%',#{name},'%')]]>
		</if>
	</select>
	
	<select id="getTrajectoryByCustomerId" parameterType="java.lang.Long" resultMap="TRAJECTORY_RESULT">
		select id,<include refid="TRAJECTORY_SQL"/> from child_trajectory where customer_id = #{customerId} and is_deleted = 1
	</select>
</mapper>